# Streamlit ì•±: ëŒ€ì¤‘êµí†µí˜„í™©ì¡°ì‚¬ (ì‹¬í”Œí˜• ì—…ë¡œë“œ ë²„ì „)
# ì‚¬ìš©ë²•: main.pyë¡œ ì €ì¥ í›„ Streamlit Cloud ë˜ëŠ” ë¡œì»¬ì—ì„œ ì‹¤í–‰
# í„°ë¯¸ë„: streamlit run main.py

import streamlit as st
import pandas as pd
import altair as alt

st.set_page_config(page_title="ëŒ€ì¤‘êµí†µ ì ‘ê·¼ìˆ˜ë‹¨ ì‹œê°í™”", layout="wide")

st.title("ğŸš ëŒ€ì¤‘êµí†µ ì ‘ê·¼ìˆ˜ë‹¨ ì‹œê°í™” (ì‹¬í”Œ ë²„ì „)")
st.markdown("CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ê·¸ë˜í”„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")

# âœ… íŒŒì¼ ì—…ë¡œë“œ
uploaded_file = st.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ", type=["csv"])

if uploaded_file is not None:
    # ì—¬ëŸ¬ ì¸ì½”ë”©ì„ ì‹œë„í•´ì„œ ìë™ íƒìƒ‰
    for enc in ("cp949", "utf-8-sig", "utf-8", "euc-kr"):
        try:
            df = pd.read_csv(uploaded_file, encoding=enc)
            st.success(f"âœ… íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (ì¸ì½”ë”©: {enc})")
            break
        except Exception:
            df = None
    else:
        st.error("âŒ CSV íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸ì½”ë”©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")
        st.stop()

    # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
    st.subheader("ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
    st.dataframe(df.head(20))

    # ì»¬ëŸ¼ ì´ë¦„ ì¶”ì •
    cols = df.columns.tolist()
    st.divider()

    # ì§€ì—­/ì—°ë„/ê°’ ì»¬ëŸ¼ ì„ íƒ
    region_col = st.selectbox("ì‹œë„(ì§€ì—­) ì»¬ëŸ¼ ì„ íƒ", options=cols)
    year_col = st.selectbox("ì—°ë„ ì»¬ëŸ¼ ì„ íƒ", options=[None] + cols)
    value_cols = st.multiselect("ì‹œê°í™”í•  ì§€í‘œ ì„ íƒ", options=[c for c in cols if c not in [region_col, year_col]], default=[cols[-1]])

    if not value_cols:
        st.warning("í‘œì‹œí•  ì§€í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.")
        st.stop()

    # ì—°ë„í˜• ì»¬ëŸ¼ì´ ì¡´ì¬í•  ê²½ìš°: ë¼ì¸ ì°¨íŠ¸
    if year_col:
        try:
            df[year_col] = pd.to_numeric(df[year_col], errors="coerce")
        except Exception:
            pass

        df_long = df.melt(id_vars=[region_col, year_col], value_vars=value_cols, var_name="ì§€í‘œ", value_name="ê°’")
        df_long = df_long.dropna(subset=["ê°’"])

        st.subheader("ğŸ“ˆ ì—°ë„ë³„ ì¶”ì´ (ë¼ì¸ ì°¨íŠ¸)")
        line_chart = alt.Chart(df_long).mark_line(point=True).encode(
            x=alt.X(f"{year_col}:O", title="ì—°ë„"),
            y=alt.Y("ê°’:Q", title="ê°’"),
            color="ì§€í‘œ:N",
            tooltip=[region_col, year_col, "ì§€í‘œ", "ê°’"]
        ).properties(height=400)

        st.altair_chart(line_chart, use_container_width=True)

    # ë§‰ëŒ€ ê·¸ë˜í”„ (ì§€í‘œë³„ ì§€ì—­ ë¹„êµ)
    st.subheader("ğŸ“Š ì§€ì—­ë³„ ì§€í‘œ ë¹„êµ (ë§‰ëŒ€ê·¸ë˜í”„)")
    df_bar = df.melt(id_vars=[region_col], value_vars=value_cols, var_name="ì§€í‘œ", value_name="ê°’")
    df_bar = df_bar.dropna(subset=["ê°’"])

    bar_chart = alt.Chart(df_bar).mark_bar().encode(
        y=alt.Y(f"{region_col}:N", sort='-x', title="ì‹œë„"),
        x=alt.X("ê°’:Q", title="ê°’"),
        color="ì§€í‘œ:N",
        tooltip=[region_col, "ì§€í‘œ", "ê°’"]
    ).properties(height=400)

    st.altair_chart(bar_chart, use_container_width=True)

    # ìš”ì•½ í†µê³„
    st.divider()
    st.subheader("ğŸ“‹ ìš”ì•½ í†µê³„")
    st.write(df[value_cols].describe())

else:
    st.info("ì™¼ìª½ ìƒë‹¨ì—ì„œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì‹œê°í™”ë©ë‹ˆë‹¤.")
